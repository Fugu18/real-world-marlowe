
***** Test "Contract for Differences with Oracle" *****
[Comment] Create the wallet for the party, fund it with 80 ADA, and activate the Marlowe endpoints.
[CreateWallet] Created wallet fd0529be35cb4d2cd64c15a3f4dd66bd9b57eabd for role "Party".
[FundWallet] Funded wallet fd0529be35cb4d2cd64c15a3f4dd66bd9b57eabd for role "Party" with valueFromList [(AdaAssetId,80000000)].
[ActivateApp] Activated MarloweApp instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a for role "Party".
[Comment] Create the wallet for the counterparty, fund it with 60 ADA, and activate the Marlowe endpoints.
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received NewObservableState Null.
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received NewYieldedExportTxs [].
[CreateWallet] Created wallet ea0217bfccbbec846380e97506abc10519fef469 for role "Counterparty".
[FundWallet] Funded wallet ea0217bfccbbec846380e97506abc10519fef469 for role "Counterparty" with valueFromList [(AdaAssetId,60000000)].
[ActivateApp] Activated MarloweApp instance 2ebeb293-6f08-402b-b510-b72973e70865 for role "Counterparty".
[Comment] Create the wallet for the oracle, fund it with 20 ADA, and activate the Marlowe endpoints.
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received NewObservableState Null.
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received NewYieldedExportTxs [].
[CreateWallet] Created wallet 58e6b12c3a9107f44f35e5364d4ae2eaf0ca5fbf for role "Oracle".
[FundWallet] Funded wallet 58e6b12c3a9107f44f35e5364d4ae2eaf0ca5fbf for role "Oracle" with valueFromList [(AdaAssetId,20000000)].
[ActivateApp] Activated MarloweApp instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 for role "Oracle".
[Comment] The oracle creates the contract with differences, which was downloaded from Marlowe Playground. The party deposits 20 ADA to cover the margin collateral and the counterparty deposits 30 ADA.
[CallCreate] Endpoint "create" called on instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 for owners [("Party",AddressInEra (ShelleyAddressInEra ShelleyBasedEraShelley) (ShelleyAddress Testnet (KeyHashObj (KeyHash "77ad4148924ec5cfcbb4aa44a42a09bd80bb5b1137876156f13c903a")) (StakeRefBase (KeyHashObj (KeyHash "ac243bf2a052d5e3937f8b7452155cc18df2956b07d5b0668593cc42"))))),("Counterparty",AddressInEra (ShelleyAddressInEra ShelleyBasedEraShelley) (ShelleyAddress Testnet (KeyHashObj (KeyHash "1cbc1b78ae417f3707710e0574fc924b3ba5c22bd03098e2c85af822")) (StakeRefBase (KeyHashObj (KeyHash "bc28b53affc57f7908ae664d2c8ce31a675527bdee09975026305b87"))))),("Oracle",AddressInEra (ShelleyAddressInEra ShelleyBasedEraShelley) (ShelleyAddress Testnet (KeyHashObj (KeyHash "3e1a0a860d8d733c8cd38457c351021584d662d901cdde92652c50ca")) (StakeRefBase (KeyHashObj (KeyHash "05286fe6543c039ef47b5ae19a6715d1ca2faf4ec8486a7f69b91c97")))))].
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewObservableState Null.
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewYieldedExportTxs [].
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewActiveEndpoints [].
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewObservableState (Object (fromList [("contents",Array [String "d500759c-fd23-4654-9fb7-711001212a55",Object (fromList [("contents",Object (fromList [("rolePayoutValidatorHash",String "d380833f3b5da553ab51c4699a031469548f1df4574e5b5043314755"),("rolesCurrency",Object (fromList [("unCurrencySymbol",String "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f")]))])),("tag",String "CreateResponse")])]),("tag",String "EndpointSuccess")])).
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[AwaitCreate] Creation confirmed with MarloweParams {rolePayoutValidatorHash = d380833f3b5da553ab51c4699a031469548f1df4574e5b5043314755, rolesCurrency = 2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f}.
[Comment] The oracle should have 14 ADA now, since 2 ADA was sent to the script address when creating the contract and 2 ADA each was sent to the party and counterparty along with their role tokens, and up to 1 ADA in fees might have been paid.
[CheckFunds] Wallet for role "Oracle" contains valueFromList [(AdaAssetId,13443061),(AssetId "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f" "Oracle",1)].
[Comment] The party and counterpary should each now have an additional 2 ADA that arrived with their role token.
[CheckFunds] Wallet for role "Party" contains valueFromList [(AdaAssetId,82000000),(AssetId "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f" "Party",1)].
[CheckFunds] Wallet for role "Counterparty" contains valueFromList [(AdaAssetId,62000000),(AssetId "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f" "Counterparty",1)].
[Comment] The party and counterparty each need to follow the contract created by the mediator.
[Follow] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a now follows instance 1bbd70c3-1ea6-4eab-98df-0852b150d450.
[Follow] Instance 2ebeb293-6f08-402b-b510-b72973e70865 now follows instance 1bbd70c3-1ea6-4eab-98df-0852b150d450.
[Comment] The party deposits their 20 ADA margin.
[CallApplyInputs] Endpoint "apply-inputs" called on a1a1c330-814a-4c08-89d0-56a3fa31ad4a for inputs [ClientInput (IDeposit "Party" "Party" (Token "" "") 20000000)] and times Just (POSIXTime {getPOSIXTime = 1645590825000},POSIXTime {getPOSIXTime = 1898051625000}).
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received NewActiveEndpoints [].
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received NewObservableState (Object (fromList [("contents",Array [String "6eff2b33-c2ef-449f-b3dd-0b772667a79a",Object (fromList [("tag",String "ApplyInputsResponse")])]),("tag",String "EndpointSuccess")])).
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[AwaitApplyInputs] Input application confirmed.
[Comment] The party should have about 62 ADA now, since they paid 20 ADA for the margin, but there is up to an additional 2 ADA in fees.
[CheckFunds] Wallet for role "Party" contains valueFromList [(AdaAssetId,60620709),(AssetId "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f" "Party",1)].
[Comment] The counterparty deposits their 30 ADA margin.
[CallApplyInputs] Endpoint "apply-inputs" called on 2ebeb293-6f08-402b-b510-b72973e70865 for inputs [ClientInput (IDeposit "Counterparty" "Counterparty" (Token "" "") 30000000)] and times Just (POSIXTime {getPOSIXTime = 1645590825000},POSIXTime {getPOSIXTime = 1898051625000}).
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received NewActiveEndpoints [].
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received NewObservableState (Object (fromList [("contents",Array [String "4c7348df-f1f5-44d8-b30a-3ca23e0d88f6",Object (fromList [("tag",String "ApplyInputsResponse")])]),("tag",String "EndpointSuccess")])).
[AwaitApplyInputs] Input application confirmed.
[Comment] The counterparty should have about 32 ADA now, since they paid 30 ADA for the margin purchase, but there is up to an additional 2 ADA in fees.
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[CheckFunds] Wallet for role "Counterparty" contains valueFromList [(AdaAssetId,30655225),(AssetId "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f" "Counterparty",1)].
[Comment] The oracle reports that the price is 1.2 ADA/USD in the first window.
[CallApplyInputs] Endpoint "apply-inputs" called on 1bbd70c3-1ea6-4eab-98df-0852b150d450 for inputs [ClientInput (IChoice (ChoiceId "ADA/USD" "Oracle") 1200000)] and times Just (POSIXTime {getPOSIXTime = 1645590825000},POSIXTime {getPOSIXTime = 1898051625000}).
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewActiveEndpoints [].
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewObservableState (Object (fromList [("contents",Array [String "83b87022-6fd3-4ce8-903c-042e3057b5b6",Object (fromList [("tag",String "ApplyInputsResponse")])]),("tag",String "EndpointSuccess")])).
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[AwaitApplyInputs] Input application confirmed.
[Comment] The oracle should still have 14 ADA now, but they may have paid up to another 2 ADA in fees.
[CheckFunds] Wallet for role "Oracle" contains valueFromList [(AdaAssetId,12024398),(AssetId "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f" "Oracle",1)].
[Comment] The oracle reports that the price is 0.700000 USD/ADA in the second window.
[WaitFor] Waited for 12000 milliseconds.
[CallApplyInputs] Endpoint "apply-inputs" called on 1bbd70c3-1ea6-4eab-98df-0852b150d450 for inputs [ClientInput (IChoice (ChoiceId "USD/ADA" "Oracle") 700000)] and times Just (POSIXTime {getPOSIXTime = 1645590825000},POSIXTime {getPOSIXTime = 1898051625000}).
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewActiveEndpoints [].
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewObservableState (Object (fromList [("contents",Array [String "d9df1b85-82cc-4d65-b5de-4c540f1a712b",Object (fromList [("tag",String "ApplyInputsResponse")])]),("tag",String "EndpointSuccess")])).
[runContract] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[AwaitApplyInputs] Input application confirmed.
[Comment] The oracle should have 16 ADA now because they received their original min-ADA deposit back, but they may have paid up to another 2 ADA in fees.
[CheckFunds] Wallet for role "Oracle" contains valueFromList [(AdaAssetId,12304312),(AssetId "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f" "Oracle",1)].
[Comment] Now the party redeems from the payout script their 36 ADA, margin plus profit.
[CallRedeem] Endpoint "redeem" called on a1a1c330-814a-4c08-89d0-56a3fa31ad4a for role "Party".
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received NewActiveEndpoints [].
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received NewObservableState (Object (fromList [("contents",Array [String "2b121247-8505-4906-b68b-0fc430715044",Object (fromList [("tag",String "RedeemResponse")])]),("tag",String "EndpointSuccess")])).
[AwaitRedeem] Redemption confirmed.
[Comment] The party should now have 98 ADA, but they may have paid up to 1 ADA more in fees.
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[CheckFunds] Wallet for role "Party" contains valueFromList [(AdaAssetId,96192111),(AssetId "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f" "Party",1)].
[Comment] Now the counterparty redeems their remaining 14 ADA margin from the payout script.
[CallRedeem] Endpoint "redeem" called on 2ebeb293-6f08-402b-b510-b72973e70865 for role "Counterparty".
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received NewActiveEndpoints [].
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received NewObservableState (Object (fromList [("contents",Array [String "b70ce39d-8b09-4a94-9d0a-45d00e6e1765",Object (fromList [("tag",String "RedeemResponse")])]),("tag",String "EndpointSuccess")])).
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received NewActiveEndpoints [ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "close"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "redeem"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "auto"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs-nonmerkleized"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "apply-inputs"}, aeMetadata = Nothing},ActiveEndpoint {aeDescription = EndpointDescription {getEndpointDescription = "create"}, aeMetadata = Nothing}].
[AwaitRedeem] Redemption confirmed.
[Comment] The counterparty should now have 46 ADA, but they may have paid up to 1 ADA more in fees.
[CheckFunds] Wallet for role "Counterparty" contains valueFromList [(AdaAssetId,44202079),(AssetId "2cfe2e2d4aa2d08dd0a2cc5dbc1c7d7a5de5be8d63e1e45db0b12b6f" "Counterparty",1)].
[Comment] Stop the Marlowe application.
[runContract] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a received ContractFinished Nothing.
[Stop] Instance a1a1c330-814a-4c08-89d0-56a3fa31ad4a stopped.
[Stop] Instance 2ebeb293-6f08-402b-b510-b72973e70865 stopped.
[runContract] Instance 2ebeb293-6f08-402b-b510-b72973e70865 received ContractFinished Nothing.
[Stop] Instance 1bbd70c3-1ea6-4eab-98df-0852b150d450 stopped.
***** SUCCEEDED *****
