#!/usr/bin/env bash


# Test of double-satisfaction from Marlowe scripts.
#
# This script creates two running contracts that are ready to close. It then
# runs a transaction that simultaneously closes both contracts, stealing ADA
# from one party.
#
# Prerequisites:
#   1. Set the paths in PARTY_A_PREFIX and PARTY_B_PREFIX below.
#   2. Set CARDANO_NODE_SOCKET_PATH.
#   3. The following tools must be on the PATH:
#      *  marlowe-cli
#      *  cardano-cli
#      *  jq
#      *  sed
#      *  xargs


set -ev


# Because of the transaction size, this test must be run on the private Marlowe
# testnet.

if [[ -z "$MAGIC" ]]
then
  MAGIC=1567
fi
echo "MAGIC=$MAGIC"
MAGIC=1566


# Configure the first party.

PARTY_A_PREFIX="$TREASURY/francis-beaumont"
PARTY_A_PAYMENT_SKEY="$PARTY_A_PREFIX".skey
PARTY_A_PAYMENT_VKEY="$PARTY_A_PREFIX".vkey

# Create the first party's keys, if necessary.

if [[ ! -e "$PARTY_A_PAYMENT_SKEY" ]]
then
  cardano-cli address key-gen --signing-key-file "$PARTY_A_PAYMENT_SKEY"      \
                              --verification-key-file "$PARTY_A_PAYMENT_VKEY"
fi
PARTY_A_ADDRESS=$(cardano-cli address build --testnet-magic "$MAGIC" --payment-verification-key-file "$PARTY_A_PAYMENT_VKEY" )
PARTY_A_PUBKEYHASH=$(cardano-cli address key-hash --payment-verification-key-file "$PARTY_A_PAYMENT_VKEY")


# Fund the first party's address.

marlowe-cli util faucet --testnet-magic "$MAGIC"                  \
                        --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                        --out-file /dev/null                      \
                        --submit 600                              \
                        --lovelace 100000000                      \
                        "$PARTY_A_ADDRESS"
TxId "f795fc50223b72fc677e964a6082fc40e234b1c0133d5aa1f838dc74cd919338"

marlowe-cli util clean --testnet-magic "$MAGIC"                  \
                       --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                       --required-signer "$PARTY_A_PAYMENT_SKEY" \
                       --change-address "$PARTY_A_ADDRESS"       \
                       --out-file /dev/null                      \
                       --submit=600                              \
> /dev/null

cardano-cli query utxo --testnet-magic "$MAGIC" --address "$PARTY_A_ADDRESS"
                           TxHash                                 TxIx        Amount
--------------------------------------------------------------------------------------
78c33180c8b0d41f42240c2342ee73cbb26c597efd7fecf43db75a23f764a5d0     0        99834279 lovelace + TxOutDatumNone


# We select the UTxO with sufficient funds to use in executing the contract.

TX_0_PARTY_A=$(
marlowe-cli util select --testnet-magic "$MAGIC"                  \
                        --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                        --lovelace-only 50000000                  \
                        "$PARTY_A_ADDRESS"                        \
| sed -n -e '1{s/^TxIn "\(.*\)" (TxIx \(.*\))$/\1#\2/;p}'         \
)


# Configure the second party.

PARTY_B_PREFIX="$TREASURY/christopher-marlowe"
PARTY_B_PAYMENT_SKEY="$PARTY_B_PREFIX".skey
PARTY_B_PAYMENT_VKEY="$PARTY_B_PREFIX".vkey


# Create the second party's keys, if necessary.

if [[ ! -e "$PARTY_B_PAYMENT_SKEY" ]]
then
  cardano-cli address key-gen --signing-key-file "$PARTY_B_PAYMENT_SKEY"      \
                              --verification-key-file "$PARTY_B_PAYMENT_VKEY"
fi
PARTY_B_ADDRESS=$(cardano-cli address build --testnet-magic "$MAGIC" --payment-verification-key-file "$PARTY_B_PAYMENT_VKEY" )
PARTY_B_PUBKEYHASH=$(cardano-cli address key-hash --payment-verification-key-file "$PARTY_B_PAYMENT_VKEY")


# Fund the second party's address.

marlowe-cli util faucet --testnet-magic "$MAGIC"                  \
                        --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                        --out-file /dev/null                      \
                        --submit 600                              \
                        --lovelace 100000000                      \
                        "$PARTY_B_ADDRESS"
TxId "c1c0d5f80c61ecfe4f6c8a8be508f966714da95c571d229239ed487f15436417"

marlowe-cli util clean --testnet-magic "$MAGIC"                  \
                       --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                       --required-signer "$PARTY_B_PAYMENT_SKEY" \
                       --change-address "$PARTY_B_ADDRESS"       \
                       --out-file /dev/null                      \
                       --submit=600                              \
> /dev/null

cardano-cli query utxo --testnet-magic "$MAGIC" --address "$PARTY_B_ADDRESS"
                           TxHash                                 TxIx        Amount
--------------------------------------------------------------------------------------
d58ee265d24fda2fda476a4758fc303d184afd4f41a22d4921e6c9cffa5b148a     0        99834279 lovelace + TxOutDatumNone


# We select the UTxO with sufficient funds to use in executing the contract.

TX_0_PARTY_B=$(
marlowe-cli util select --testnet-magic "$MAGIC"                  \
                        --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                        --lovelace-only 50000000                  \
                        "$PARTY_B_ADDRESS"                        \
| sed -n -e '1{s/^TxIn "\(.*\)" (TxIx \(.*\))$/\1#\2/;p}'         \
)


# Configure the validator.

CONTRACT_ADDRESS=$(marlowe-cli contract address --testnet-magic "$MAGIC")

marlowe-cli contract validator --testnet-magic "$MAGIC"     \
                               --out-file marlowe.plutus    \
                               --print-stats
addr_test1wp20ushgkk9nsfdcetcxpac8dgx09q08yhtdskptacvkcxsz2qjzl

Validator size: 12604
Bare-validator cost: ExBudget {exBudgetCPU = ExCPU 24920101, exBudgetMemory = ExMemory 83800}


# Find the protocol parameters and the tip.

cardano-cli query  protocol-parameters --testnet-magic "$MAGIC" --out-file private.protocol

TIP=$(cardano-cli query tip --testnet-magic "$MAGIC" | jq '.slot')

MINIMUM_SLOT="$TIP"
TIMEOUT_SLOT="$((TIP+4*3600))"


# Transaction 1. Configure the first contract.

# In the first contract, the first party has 25 ADA their account and the second
# party has 3 ADA in theirs. We ignore the prior operation of the contract and
# assume without loss of generality that the contract has reached "close".

cat > tx-1.state << EOI
{
  "choices": [],
  "accounts": [
    [
      [ { "pk_hash": "$PARTY_A_PUBKEYHASH" }, { "currency_symbol": "", "token_name": "" } ],
      25000000
    ],
    [
      [ { "pk_hash": "$PARTY_B_PUBKEYHASH" },
        { "currency_symbol": "", "token_name": "" } ],
      3000000
    ]
  ],
  "minTime": 1,
  "boundValues": []
}
EOI

cat > tx-1.contract << EOI
"close"
EOI

marlowe-cli contract datum --contract-file tx-1.contract \
                           --state-file    tx-1.state    \
                           --out-file      tx-1.datum
e94f4b21e7fd80fe984a9d0057f1d2a37ad5283fb93e5c9b284b17f81274d502

TX_1=$(
marlowe-cli transaction create --testnet-magic "$MAGIC"                  \
                               --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                               --tx-in "$TX_0_PARTY_A"                   \
                               --change-address "$PARTY_A_ADDRESS"       \
                               --required-signer "$PARTY_A_PAYMENT_SKEY" \
                               --script-address "$CONTRACT_ADDRESS"      \
                               --tx-out-datum-file tx-1.datum            \
                               --tx-out-marlowe 28000000                 \
                               --out-file tx-1.raw                       \
                               --print-stats                             \
                               --submit=600                              \
| sed -e 's/^TxId "\(.*\)"$/\1/'                                         \
)

Fee: Lovelace 175445
Size: 314 / 32768 = 0%
Execution units:
  Memory: 0 / 30000000 = 0%
  Steps: 0 / 10000000000 = 0%
echo "TxId $TX_1"
TxId ac85a118273a219949346c449edd2118042e24f3a6abe0e12fd1e78251498293


# Transaction 2. Configure the second contract.

# In the second contract, the first party has 20 ADA their account and the
# second party has 4 ADA in theirs. We ignore the prior operation of the
# contract and assume without loss of generality that the contract has reached
# "close".

cat > tx-2.state << EOI
{
  "choices": [],
  "accounts": [
    [
      [ { "pk_hash": "$PARTY_A_PUBKEYHASH" }, { "currency_symbol": "", "token_name": "" } ],
      20000000
    ],
    [
      [ { "pk_hash": "$PARTY_B_PUBKEYHASH" },
        { "currency_symbol": "", "token_name": "" } ],
      4000000
    ]
  ],
  "minTime": 1,
  "boundValues": []
}
EOI

cat > tx-2.contract << EOI
"close"
EOI

marlowe-cli contract datum --contract-file tx-2.contract \
                           --state-file    tx-2.state    \
                           --out-file      tx-2.datum
5a37cf4a2970c0a1bd93f71785962fb4931046e9cba0d4ffc0dce8a97f5f9f63

TX_2=$(
marlowe-cli transaction create --testnet-magic "$MAGIC"                  \
                               --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                               --tx-in "$TX_0_PARTY_B"                   \
                               --change-address "$PARTY_B_ADDRESS"       \
                               --required-signer "$PARTY_B_PAYMENT_SKEY" \
                               --script-address "$CONTRACT_ADDRESS"      \
                               --tx-out-datum-file tx-2.datum            \
                               --tx-out-marlowe 24000000                 \
                               --out-file tx-2.raw                       \
                               --print-stats                             \
                               --submit=600                              \
| sed -e 's/^TxId "\(.*\)"$/\1/'                                         \
)

Fee: Lovelace 175445
Size: 314 / 32768 = 0%
Execution units:
  Memory: 0 / 30000000 = 0%
  Steps: 0 / 10000000000 = 0%
echo "TxId $TX_2"
TxId 56ea2ed56fc45cf5fd39608232f63495374e94f9ccc94f6e9a0cdef23dc5cac0


# Transaction 3. The second party steals 20 ADA from the first party.

# Each contract is ready to close. When the first contract closes, it should
# pay 25 ADA to the first party and 3 ADA to the second party. When the seconnd
# contract closes, it should pay 20 ADA to the first party and 4 ADA to the
# second party. We can verify this by checking the transactions for running the
# two contracts separately and together.

# Compute the redeemers for the two UTxOs at the contract address:

marlowe-cli contract redeemer --out-file tx-2-first.redeemer
marlowe-cli contract redeemer --out-file tx-2-second.redeemer

# Perform a dry-run of redeeming the first contact: the first party receives
# their 25 ADA and the second party receives their 3 ADA. If the following
# command prints the transaction ID, that indicates that the transaction would
# run without error. (It doesn't matter which party submits this transaction.)

marlowe-cli transaction close --testnet-magic "$MAGIC"                   \
                              --socket-path "$CARDANO_NODE_SOCKET_PATH"  \
                              --tx-in-marlowe "$TX_1"#1                  \
                              --tx-in-script-file marlowe.plutus         \
                              --tx-in-datum-file tx-1.datum              \
                              --tx-in-redeemer-file tx-2-first.redeemer  \
                              --tx-in "$TX_2"#0                          \
                              --tx-in-collateral "$TX_2"#0               \
                              --required-signer "$PARTY_B_PAYMENT_SKEY"  \
                              --tx-out "$PARTY_A_ADDRESS+25000000"       \
                              --tx-out "$PARTY_B_ADDRESS+3000000"        \
                              --change-address "$PARTY_B_ADDRESS"        \
                              --invalid-before "$MINIMUM_SLOT"           \
                              --invalid-hereafter "$TIMEOUT_SLOT"        \
                              --out-file tx-2.raw                        \
                              --print-stats

Fee: Lovelace 983100
Size: 13055 / 32768 = 39%
Execution units:
  Memory: 2891100 / 30000000 = 9%
  Steps: 988322253 / 10000000000 = 9%
TxId "da882b9f259b23d7c9000f32109cfe4ab4ecb7369c6d9ceffc12ded5b9cd486e"

# Perform a dry-run of redeeming the second contact: the first party receives
# their 20 ADA and the second party receives their 4 ADA. If the following
# command prints the transaction ID, that indicates that the transaction would
# run without error. (It doesn't matter which party submits this transaction.)

marlowe-cli transaction close --testnet-magic "$MAGIC"                   \
                              --socket-path "$CARDANO_NODE_SOCKET_PATH"  \
                              --tx-in-marlowe "$TX_2"#1                  \
                              --tx-in-script-file marlowe.plutus         \
                              --tx-in-datum-file tx-2.datum              \
                              --tx-in-redeemer-file tx-2-second.redeemer \
                              --tx-in "$TX_2"#0                          \
                              --tx-in-collateral "$TX_2"#0               \
                              --required-signer "$PARTY_B_PAYMENT_SKEY"  \
                              --tx-out "$PARTY_A_ADDRESS+20000000"       \
                              --tx-out "$PARTY_B_ADDRESS+4000000"        \
                              --change-address "$PARTY_B_ADDRESS"        \
                              --invalid-before "$MINIMUM_SLOT"           \
                              --invalid-hereafter "$TIMEOUT_SLOT"        \
                              --out-file tx-2.raw                        \
                              --print-stats

Fee: Lovelace 983643
Size: 13055 / 32768 = 39%
Execution units:
  Memory: 2897704 / 30000000 = 9%
  Steps: 990563009 / 10000000000 = 9%
TxId "0ed5313520b4e215f65236c7b26e00e2f5e8c27750740aff91e4c6e4e0948495"

# Perform a dry-run of redeeming both contracts at once: the first party only
# receives their 25 ADA from the first contract and the second party steals
# the first party's 20 ADA from the second contract because the second validator
# sees that >= 20 ADA is sent to the first party--i.e., this is a double-spend
# attack; the the second party receives 20+3+4=27 ADA put. If the following
# commands succeeds, that indicates that the transaction would run without
# error. (It doesn't matter which party submits this transaction, but the second
# party submits it because they are the thief.)

if cardano-cli transaction build --testnet-magic "$MAGIC" --alonzo-era                   \
                                 --protocol-params-file private.protocol      \
                                 --tx-in "$TX_1"#1                            \
                                   --tx-in-script-file marlowe.plutus         \
                                   --tx-in-datum-file tx-1.datum              \
                                   --tx-in-redeemer-file tx-2-first.redeemer  \
                                 --tx-in "$TX_2"#1                            \
                                   --tx-in-script-file marlowe.plutus         \
                                   --tx-in-datum-file tx-2.datum              \
                                   --tx-in-redeemer-file tx-2-second.redeemer \
                                 --tx-in "$TX_2"#0                            \
                                 --tx-in-collateral "$TX_2"#0                 \
                                 --required-signer "$PARTY_B_PAYMENT_SKEY"    \
                                 --tx-out "$PARTY_A_ADDRESS+25000000"         \
                                 --tx-out "$PARTY_B_ADDRESS+27000000"         \
                                 --change-address "$PARTY_B_ADDRESS"          \
                                 --invalid-before "$MINIMUM_SLOT"             \
                                 --invalid-hereafter "$TIMEOUT_SLOT"          \
                                 --out-file tx-2.raw
then
  echo "Double satisfaction was prevented."
  exit 1
else
  echo "Double satisfaction was not prevented."
fi
Command failed: transaction build  Error: The following scripts have execution failures:
the script for transaction input 1 (in the order of the TxIds) failed with: 
The Plutus script evaluation failed: An error has occurred:  User error:
The provided Plutus code called 'error'.
Script debugging logs: I1

the script for transaction input 2 (in the order of the TxIds) failed with: 
The Plutus script evaluation failed: An error has occurred:  User error:
The provided Plutus code called 'error'.
Script debugging logs: I1


Double satisfaction was not prevented.
