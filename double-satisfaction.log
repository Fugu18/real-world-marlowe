# Because of the transaction size, this test must be run on the private Marlowe
# testnet.

MAGIC=(--testnet-magic 1564)
SLOT_LENGTH=1000
SLOT_OFFSET=1644929640000


# Configure the first party.

PARTY_A_PREFIX="$TREASURY/francis-beaumont"
PARTY_A_PAYMENT_SKEY="$PARTY_A_PREFIX".skey
PARTY_A_PAYMENT_VKEY="$PARTY_A_PREFIX".vkey
PARTY_A_ADDRESS=$(
  cardano-cli address build "${MAGIC[@]}"                                           \
                            --payment-verification-key-file "$PARTY_A_PAYMENT_VKEY" \
)
PARTY_A_PUBKEYHASH=$(
  cardano-cli address key-hash --payment-verification-key-file "$PARTY_A_PAYMENT_VKEY"
)

# The first party has the address addr_test1vrtntkszteptml4e9ce9l3fsmgavwv4ywunvdnhxv6nw5ksq6737a
# and the public-key hash d735da025e42bdfeb92e325fc530da3ac732a47726c6cee666a6ea5a.
# They have the following UTxOs in their wallet:

marlowe-cli util clean "${MAGIC[@]}"                             \
                       --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                       --required-signer "$PARTY_A_PAYMENT_SKEY" \
                       --change-address "$PARTY_A_ADDRESS"       \
                       --out-file /dev/null                      \
                       --submit=600                              \
> /dev/null
cardano-cli query utxo "${MAGIC[@]}" --address "$PARTY_A_ADDRESS"
                           TxHash                                 TxIx        Amount
--------------------------------------------------------------------------------------
10e33607d6e5bd692a3dd7c56340294ab7c9ba2aad1384242e20e9e1908f5c68     0        11339214245 lovelace + TxOutDatumNone
10e33607d6e5bd692a3dd7c56340294ab7c9ba2aad1384242e20e9e1908f5c68     1        2000000 lovelace + 1 8bb3b343d8e404472337966a722150048c768d0a92a9813596c5338d.4642 + TxOutDatumNone

# We select the UTxO with the most funds to use in executing the contract.
TX_0_PARTY_A=$(
cardano-cli query utxo "${MAGIC[@]}"                                                                           \
                       --address "$PARTY_A_ADDRESS"                                                            \
                       --out-file /dev/stdout                                                                  \
| jq -r '. | to_entries | sort_by(- .value.value.lovelace) | .[] | select((.value.value | length) ==1) | .key' \
| head -n 1                                                                                                    \
)
# The first party will spend the UTxO 10e33607d6e5bd692a3dd7c56340294ab7c9ba2aad1384242e20e9e1908f5c68#0.


# Configure the second party.

PARTY_B_PREFIX="$TREASURY/christopher-marlowe"
PARTY_B_PAYMENT_SKEY="$PARTY_B_PREFIX".skey
PARTY_B_PAYMENT_VKEY="$PARTY_B_PREFIX".vkey
PARTY_B_ADDRESS=$(
  cardano-cli address build "${MAGIC[@]}"                                           \
                            --payment-verification-key-file "$PARTY_B_PAYMENT_VKEY" \
)
PARTY_B_PUBKEYHASH=$(
  cardano-cli address key-hash --payment-verification-key-file "$PARTY_B_PAYMENT_VKEY"
)

# The second party has the address addr_test1vqhqudxtwqcpjqesns79hqgqq2q0xx5q0hnzz5es9492yaqpxltpy
# and public-key hash 2e0e34cb70301903309c3c5b81000280f31a807de62153302d4aa274.
# They have the following UTxOs in their wallet:

marlowe-cli util clean "${MAGIC[@]}"                             \
                       --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                       --required-signer "$PARTY_B_PAYMENT_SKEY" \
                       --change-address "$PARTY_B_ADDRESS"       \
                       --out-file /dev/null                      \
                       --submit=600                              \
> /dev/null
cardano-cli query utxo "${MAGIC[@]}" --address "$PARTY_B_ADDRESS"
                           TxHash                                 TxIx        Amount
--------------------------------------------------------------------------------------
95ddae1e9eb6c89dd17f19f2919c85422323c18a4dc2dbb01a369d8e3b462568     0        21812318412 lovelace + TxOutDatumNone
95ddae1e9eb6c89dd17f19f2919c85422323c18a4dc2dbb01a369d8e3b462568     1        2000000 lovelace + 5000 8bb3b343d8e404472337966a722150048c768d0a92a9813596c5338d.4265617247617264656e + TxOutDatumNone
95ddae1e9eb6c89dd17f19f2919c85422323c18a4dc2dbb01a369d8e3b462568     2        2000000 lovelace + 1 8bb3b343d8e404472337966a722150048c768d0a92a9813596c5338d.434d + TxOutDatumNone

# We select the UTxO with the most funds to use in executing the contract.
TX_0_PARTY_B=$(
cardano-cli query utxo "${MAGIC[@]}"                                                                           \
                       --address "$PARTY_B_ADDRESS"                                                            \
                       --out-file /dev/stdout                                                                  \
| jq -r '. | to_entries | sort_by(- .value.value.lovelace) | .[] | select((.value.value | length) ==1) | .key' \
| head -n 1                                                                                                    \
)
# The second party will spend the UTxO 95ddae1e9eb6c89dd17f19f2919c85422323c18a4dc2dbb01a369d8e3b462568#0.


# Configure the validator.

CONTRACT_ADDRESS=$(marlowe-cli contract address "${MAGIC[@]}")

marlowe-cli contract validator "${MAGIC[@]}"                \
                               --out-file marlowe.plutus    \
                               --print-stats
addr_test1wzw0y8gpcpx0rksg82w37ddrcntkrx94klevdf269g5news45dfzm

Validator size: 11932
Bare-validator cost: ExBudget {exBudgetCPU = ExCPU 24384187, exBudgetMemory = ExMemory 82000}


# Find the protocol parameters and the tip.

cardano-cli query  protocol-parameters "${MAGIC[@]}" --out-file private.protocol

TIP=$(cardano-cli query tip "${MAGIC[@]}" | jq '.slot')

MINIMUM_SLOT="$TIP"
TIMEOUT_SLOT="$((TIP+4*3600))"


# Transaction 1. Configure the first contract.

# In the first contract, the first party has 25 ADA their account and the second
# party has 3 ADA in theirs. We ignore the prior operation of the contract and
# assume without loss of generality that the contract has reached "close".

cat > tx-1.state << EOI
{
  "choices": [],
  "accounts": [
    [
      [ { "pk_hash": "$PARTY_A_PUBKEYHASH" }, { "currency_symbol": "", "token_name": "" } ],
      25000000
    ],
    [
      [ { "pk_hash": "$PARTY_B_PUBKEYHASH" },
        { "currency_symbol": "", "token_name": "" } ],
      3000000
    ]
  ],
  "minTime": 1,
  "boundValues": []
}
EOI

cat > tx-1.contract << EOI
"close"
EOI

marlowe-cli contract datum --contract-file tx-1.contract \
                           --state-file    tx-1.state    \
                           --out-file      tx-1.datum
d61596b93e133485f77b045b18b81f118540a407cae68e196d360f4fdfbba8ea

TX_1=$(
marlowe-cli transaction create "${MAGIC[@]}"                             \
                               --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                               --tx-in "$TX_0_PARTY_A"                   \
                               --change-address "$PARTY_A_ADDRESS"       \
                               --required-signer "$PARTY_A_PAYMENT_SKEY" \
                               --script-address "$CONTRACT_ADDRESS"      \
                               --tx-out-datum-file tx-1.datum            \
                               --tx-out-marlowe 28000000                 \
                               --out-file tx-1.raw                       \
                               --print-stats                             \
                               --submit=600                              \
| sed -e 's/^TxId "\(.*\)"$/\1/'                                         \
)

Fee: Lovelace 175621
Size: 318 / 32768 = 0%
Execution units:
  Memory: 0 / 30000000 = 0%
  Steps: 0 / 10000000000 = 0%
TxId cb50572c5d01c7153292b8d30b6f264493190bf84db27aeb9d1ca6b5bc7114ba


# Transaction 2. Configure the second contract.

# In the second contract, the first party has 20 ADA their account and the
# second party has 4 ADA in theirs. We ignore the prior operation of the
# contract and assume without loss of generality that the contract has reached
# "close".

cat > tx-2.state << EOI
{
  "choices": [],
  "accounts": [
    [
      [ { "pk_hash": "$PARTY_A_PUBKEYHASH" }, { "currency_symbol": "", "token_name": "" } ],
      20000000
    ],
    [
      [ { "pk_hash": "$PARTY_B_PUBKEYHASH" },
        { "currency_symbol": "", "token_name": "" } ],
      4000000
    ]
  ],
  "minTime": 1,
  "boundValues": []
}
EOI

cat > tx-2.contract << EOI
"close"
EOI

marlowe-cli contract datum --contract-file tx-2.contract \
                           --state-file    tx-2.state    \
                           --out-file      tx-2.datum
48139b8165c196232c5832e73207ad10412d1a3542449da2e1cede4d3deab994

TX_2=$(
marlowe-cli transaction create "${MAGIC[@]}"                             \
                               --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                               --tx-in "$TX_0_PARTY_B"                   \
                               --change-address "$PARTY_B_ADDRESS"       \
                               --required-signer "$PARTY_B_PAYMENT_SKEY" \
                               --script-address "$CONTRACT_ADDRESS"      \
                               --tx-out-datum-file tx-2.datum            \
                               --tx-out-marlowe 24000000                 \
                               --out-file tx-2.raw                       \
                               --print-stats                             \
                               --submit=600                              \
| sed -e 's/^TxId "\(.*\)"$/\1/'                                         \
)

Fee: Lovelace 175621
Size: 318 / 32768 = 0%
Execution units:
  Memory: 0 / 30000000 = 0%
  Steps: 0 / 10000000000 = 0%
TxId 9cb9f13b1739defa40970c752290b1053ecd63e45f8bf78be9da730cf358f4a5


# Transaction 3. The second party steals 20 ADA from the first party.

# Each contract is ready to close. When the first contract closes, it should
# pay 25 ADA to the first party and 3 ADA to the second party. When the seconnd
# contract closes, it should pay 20 ADA to the first party and 4 ADA to the
# second party. We can verify this by checking the transactions for running the
# two contracts separately and together.

# Compute the redeemers for the two UTxOs at the contract address:
marlowe-cli contract redeemer --out-file tx-2-first.redeemer
marlowe-cli contract redeemer --out-file tx-2-second.redeemer

# Perform a dry-run of redeeming the first contact: the first party receives
# their 25 ADA and the second party receives their 3 ADA. If the following
# command prints the transaction ID, that indicates that the transaction would
# run without error. (It doesn't matter which party submits this transaction.)
marlowe-cli transaction close "${MAGIC[@]}"                              \
                              --socket-path "$CARDANO_NODE_SOCKET_PATH"  \
                              --tx-in-marlowe "$TX_1"#1                  \
                              --tx-in-script-file marlowe.plutus         \
                              --tx-in-datum-file tx-1.datum              \
                              --tx-in-redeemer-file tx-2-first.redeemer  \
                              --tx-in "$TX_2"#0                          \
                              --tx-in-collateral "$TX_2"#0               \
                              --required-signer "$PARTY_B_PAYMENT_SKEY"  \
                              --tx-out "$PARTY_A_ADDRESS+25000000"       \
                              --tx-out "$PARTY_B_ADDRESS+3000000"        \
                              --change-address "$PARTY_B_ADDRESS"        \
                              --invalid-before "$MINIMUM_SLOT"           \
                              --invalid-hereafter "$TIMEOUT_SLOT"        \
                              --out-file tx-2.raw                        \
                              --print-stats

Fee: Lovelace 942621
Size: 12387 / 32768 = 37%
Execution units:
  Memory: 2751590 / 30000000 = 9%
  Steps: 946196949 / 10000000000 = 9%
TxId "61b00dec42a47de61b9bbc074ffb8e658d83a6fb76b9ce9dc4e7fac7b619ac24"

# Perform a dry-run of redeeming the second contact: the first party receives
# their 20 ADA and the second party receives their 4 ADA. If the following
# command prints the transaction ID, that indicates that the transaction would
# run without error. (It doesn't matter which party submits this transaction.)
marlowe-cli transaction close "${MAGIC[@]}"                              \
                              --socket-path "$CARDANO_NODE_SOCKET_PATH"  \
                              --tx-in-marlowe "$TX_2"#1                  \
                              --tx-in-script-file marlowe.plutus         \
                              --tx-in-datum-file tx-2.datum              \
                              --tx-in-redeemer-file tx-2-second.redeemer \
                              --tx-in "$TX_2"#0                          \
                              --tx-in-collateral "$TX_2"#0               \
                              --required-signer "$PARTY_B_PAYMENT_SKEY"  \
                              --tx-out "$PARTY_A_ADDRESS+20000000"       \
                              --tx-out "$PARTY_B_ADDRESS+4000000"        \
                              --change-address "$PARTY_B_ADDRESS"        \
                              --invalid-before "$MINIMUM_SLOT"           \
                              --invalid-hereafter "$TIMEOUT_SLOT"        \
                              --out-file tx-2.raw                        \
                              --print-stats

Fee: Lovelace 942892
Size: 12387 / 32768 = 37%
Execution units:
  Memory: 2754892 / 30000000 = 9%
  Steps: 947317327 / 10000000000 = 9%
TxId "8d04d503da77ebf59d6f646ad88eea4d0e3f776bbad2b1546f964c0b67b836a7"

# Perform a dry-run of redeeming both contracts at once: the first party
# receives their 25+20=45 ADA and the second party receives their 3+4=7 ADA. If
# the following commands succeeds, that indicates that the transaction would run
# without error. (It doesn't matter which party submits this transaction.)
cardano-cli transaction build "${MAGIC[@]}" --alonzo-era                   \
                              --protocol-params-file private.protocol      \
                              --tx-in "$TX_1"#1                            \
                                --tx-in-script-file marlowe.plutus         \
                                --tx-in-datum-file tx-1.datum              \
                                --tx-in-redeemer-file tx-2-first.redeemer  \
                              --tx-in "$TX_2"#1                            \
                                --tx-in-script-file marlowe.plutus         \
                                --tx-in-datum-file tx-2.datum              \
                                --tx-in-redeemer-file tx-2-second.redeemer \
                              --tx-in "$TX_2"#0                            \
                              --tx-in-collateral "$TX_2"#0                 \
                              --required-signer "$PARTY_B_PAYMENT_SKEY"    \
                              --tx-out "$PARTY_A_ADDRESS+45000000"         \
                              --tx-out "$PARTY_B_ADDRESS+7000000"          \
                              --change-address "$PARTY_B_ADDRESS"          \
                              --invalid-before "$MINIMUM_SLOT"             \
                              --invalid-hereafter "$TIMEOUT_SLOT"          \
                              --out-file tx-2.raw
Estimated transaction fee: Lovelace 1153019

# Perform a dry-run of redeeming both contracts at once: the first party only
# receives their 25 ADA from the first contract and the second party steals
# the first party's 20 ADA from the second contract because the second validator
# sees that >= 20 ADA is sent to the first party--i.e., this is a double-spend
# attack; the the second party receives 20+3+4=27 ADA put. If the following
# commands succeeds, that indicates that the transaction would run without
# error. (It doesn't matter which party submits this transaction, but the second
# party submits it because they are the thief.)
cardano-cli transaction build "${MAGIC[@]}" --alonzo-era                   \
                              --protocol-params-file private.protocol      \
                              --tx-in "$TX_1"#1                            \
                                --tx-in-script-file marlowe.plutus         \
                                --tx-in-datum-file tx-1.datum              \
                                --tx-in-redeemer-file tx-2-first.redeemer  \
                              --tx-in "$TX_2"#1                            \
                                --tx-in-script-file marlowe.plutus         \
                                --tx-in-datum-file tx-2.datum              \
                                --tx-in-redeemer-file tx-2-second.redeemer \
                              --tx-in "$TX_2"#0                            \
                              --tx-in-collateral "$TX_2"#0                 \
                              --required-signer "$PARTY_B_PAYMENT_SKEY"    \
                              --tx-out "$PARTY_A_ADDRESS+25000000"         \
                              --tx-out "$PARTY_B_ADDRESS+27000000"         \
                              --change-address "$PARTY_B_ADDRESS"          \
                              --invalid-before "$MINIMUM_SLOT"             \
                              --invalid-hereafter "$TIMEOUT_SLOT"          \
                              --out-file tx-2.raw
Estimated transaction fee: Lovelace 1153019

# Now sign and submit the transaction, just to make sure that the theft really
# can occur.
TX_3=$(
marlowe-cli transaction submit "${MAGIC[@]}"                             \
                               --socket-path "$CARDANO_NODE_SOCKET_PATH" \
                               --tx-body-file tx-2.raw                   \
                               --required-signer "$PARTY_B_PAYMENT_SKEY" \
                               --timeout 600                             \
| sed -e 's/^TxId "\(.*\)"$/\1/'                                         \
)
TX_3_EXIT="$?"
TxId 8cd2a12e6066334fcfbbe361897352582b6195a8b918bfc1f8ec6ab7272ad3a3

# There is no UTxO at the contract address:
cardano-cli query utxo "${MAGIC[@]}" --address "$CONTRACT_ADDRESS" | sed -n -e "1p;2p;/$TX_1/p;/$TX_2/p;/$TX_3/p"
                           TxHash                                 TxIx        Amount
--------------------------------------------------------------------------------------

# Here is the UTxO at the first party's address:
cardano-cli query utxo "${MAGIC[@]}" --address "$PARTY_A_ADDRESS" | sed -n -e "1p;2p;/$TX_1/p;/$TX_2/p;/$TX_3/p"
                           TxHash                                 TxIx        Amount
--------------------------------------------------------------------------------------
8cd2a12e6066334fcfbbe361897352582b6195a8b918bfc1f8ec6ab7272ad3a3     1        25000000 lovelace + TxOutDatumNone
cb50572c5d01c7153292b8d30b6f264493190bf84db27aeb9d1ca6b5bc7114ba     0        11311038624 lovelace + TxOutDatumNone

# Here is the UTxO at the second party's address:
cardano-cli query utxo "${MAGIC[@]}" --address "$PARTY_B_ADDRESS" | sed -n -e "1p;2p;/$TX_1/p;/$TX_2/p;/$TX_3/p"
                           TxHash                                 TxIx        Amount
--------------------------------------------------------------------------------------
8cd2a12e6066334fcfbbe361897352582b6195a8b918bfc1f8ec6ab7272ad3a3     0        21786989772 lovelace + TxOutDatumNone
8cd2a12e6066334fcfbbe361897352582b6195a8b918bfc1f8ec6ab7272ad3a3     2        27000000 lovelace + TxOutDatumNone


# Return error if the transaction succeeded.

if [ "$TX_3_EXIT" -eq 0 ]
then
  echo "Double satisfaction occurred."
  exit 1
else
  echo "Double satisfaction did not occur."
fi
Double satisfaction occurred.
